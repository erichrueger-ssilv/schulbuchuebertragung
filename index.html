<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Schulbuch-√úbertragung (Foto/PDF -> Markdown/DOCX)</title>

    <!-- PWA Manifest & Icons -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c2c33">
    <link rel="apple-touch-icon" href="icon-192.png">

    <!-- Externe Bibliotheken (Lokal) -->
    <script src="libs/pdfjs/pdf.min.js"></script>
    <script src="libs/marked/marked.min.js"></script>
    <script src="libs/html-docx/html-docx.min.js"></script>

    <!-- KaTeX CSS & JS -->
    <link rel="stylesheet" href="libs/katex/katex.min.css">
    <script src="libs/katex/katex.min.js"></script>
    <script src="libs/katex/contrib/auto-render.min.js"></script>

    <!-- Main Stylesheet (Refactored) -->
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="container">
        <!-- Linke Spalte: Controls -->
        <div class="controls" id="controls-panel">
            <div class="header-row">
                <div class="title-group">
                    <img src="logo-ssilv.png" alt="Logo" class="header-logo" id="header-logo"
                        title="√úber SBBZ-Ilvesheim">
                    <h1>E-Buch-OCR</h1>
                </div>
                <div class="header-actions">
                    <button class="header-btn" id="theme-toggle" aria-label="Design wechseln">
                        <span aria-hidden="true">üåì</span>
                    </button>
                    <button class="header-btn" id="keyboard-shortcuts-btn" title="Tastenk√ºrzel"
                        aria-label="Tastenk√ºrzel anzeigen">
                        <span aria-hidden="true">‚å®Ô∏è</span>
                    </button>

                </div>
            </div>

            <!-- Haupt-Aktionen -->
            <div class="control-group">
                <div class="input-row-combined">
                    <!-- Kamera-Button links -->
                    <button id="camera-btn" title="Kamera √∂ffnen (c)" aria-label="Kamera √∂ffnen">üì∑</button>

                    <!-- Datei-Input rechts -->
                    <label for="file-input" class="sr-only"></label>
                    <input type="file" id="file-input" accept="application/pdf,image/*" multiple
                        aria-label="Datei ausw√§hlen">
                </div>
                <!-- Dateiname Anzeige -->
                <div id="file-name-display" class="file-name-text"></div>

                <!-- File Status Indicator (Relocated Batch Count) -->
                <div class="file-status-indicator" id="file-status-indicator">
                    <span id="camera-file-count">0 Fotos</span>
                    <button id="clear-camera-btn" title="Verwerfen" aria-label="Fotos verwerfen"
                        style="margin-left:auto; font-size:1.1em; padding: 0 5px;">‚úñ</button>
                </div>

                <!-- Manueller Prompt -->
                <label for="manual-prompt" class="sr-only">Manueller Prompt:</label>
                <div id="manual-prompt-container" style="display: flex; gap: 5px; margin-top: 5px;">
                    <textarea id="manual-prompt" rows="3"
                        placeholder="Manueller Prompt / Frage zum Bild... (√ºberschreibt Standardrompt)"
                        aria-label="Manueller Prompt"></textarea>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <!-- Start/Stop -->
                <button id="toggle-processing-btn" disabled title="Verarbeitung starten/stoppen (s)">‚ñ∂ Start</button>
                <!-- Downloads -->
                <button id="download-md-btn" disabled title="Markdown herunterladen"
                    aria-label="Als Markdown herunterladen">MD</button>
                <button id="download-docx-btn" disabled title="Word-Datei herunterladen"
                    aria-label="Als Word-Datei (DOCX) herunterladen">DOCX</button>
            </div>

            <!-- Fortschrittsanzeige -->
            <div class="progress-wrapper" id="progress-wrapper">
                <div class="progress-info">
                    <span id="progress-text">Bereit</span>
                    <span id="eta-text">--:--</span>
                </div>
                <div class="progress-container">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>

            <!-- Einstellungen -->
            <details class="control-group" id="main-settings">
                <summary>Einstellungen</summary>
                <div class="details-content">
                    <div class="quick-settings-controls">
                        <select id="quick-settings-select" aria-label="Schnell-Profil w√§hlen"></select>
                        <button id="add-profile-btn" title="Profil speichern" aria-label="Profil speichern">+</button>
                        <button id="del-profile-btn" title="Profil l√∂schen" aria-label="Profil l√∂schen">üóë</button>
                    </div>

                    <div class="control-group horizontal">
                        <label for="auto-save-local">Einstellungen automatisch speichern:</label>
                        <label class="switch">
                            <input type="checkbox" id="auto-save-local" checked>
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="config-buttons">
                        <button id="save-settings-btn" title="Einstellungen in Datei speichern"
                            aria-label="Einstellungen in Datei speichern">Einstellungen sichern</button>
                        <button id="load-settings-btn" title="Einstellungen aus Datei laden"
                            aria-label="Einstellungen aus Datei laden">Einstellungen laden</button>
                        <input type="file" id="config-loader" accept=".json" style="display:none">
                    </div>

                    <!-- Verarbeitungsoptionen -->
                    <details id="processing-options-details" open>
                        <summary>Verarbeitungsoptionen</summary>
                        <div class="details-content">
                            <div class="control-group">
                                <label for="dpi">PDF Render DPI:</label>
                                <input type="number" id="dpi" value="150" step="50">
                            </div>

                            <div class="control-group">
                                <label for="page-range">Seitenbereich (z.B. 1-5, 8, 11-13) (PDF):</label>
                                <input type="text" id="page-range" placeholder="Leer lassen f√ºr alle Seiten">
                            </div>

                            <!-- Nummerierung (Relocated) -->
                            <div class="control-group horizontal">
                                <label for="enable-numbering">Seitennummerierung (( )):</label>
                                <label class="switch">
                                    <input type="checkbox" id="enable-numbering" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div id="numbering-options" style="display:none; flex-direction:column; gap:5px;">
                                <div class="control-group horizontal">
                                    <label for="start-pdf-page">Nummerierung ab PDF-Seite:</label>
                                    <input type="number" id="start-pdf-page" value="1" style="width: 60px;">
                                </div>
                                <div class="control-group horizontal">
                                    <label for="start-page-number">Nummerierung beginnt mit Seitezahl:</label>
                                    <input type="number" id="start-page-number" value="1" style="width: 60px;">
                                </div>
                            </div>

                            <!-- ToC Analyse -->
                            <div class="control-group"
                                style="padding: 10px; border: 1px solid var(--border-color); border-radius: 4px;">
                                <label
                                    style="font-weight: bold; margin-bottom: 5px; display: block;">Inhaltsverzeichnis-Analyse
                                    (VLM)</label>
                                <div style="display: flex; gap: 5px; align-items: center; margin-bottom: 5px;">
                                    <label for="toc-pages">PDF-Seiten:</label>
                                    <input type="text" id="toc-pages" placeholder="z.B. 3-5" style="flex: 1;"
                                        aria-label="ToC Seiten im PDF">
                                    <label for="toc-offset">Offset:</label>
                                    <input type="number" id="toc-offset" value="0" placeholder="Offset"
                                        title="Seitenzahl-Offset (Buch vs PDF) Wie viele Seiten gibt es in der PDF, die nicht zur Seitennummerierung des Buches z√§hlen?"
                                        style="width: 60px;" aria-label="Seitenzahl Offset">
                                </div>
                                <button id="analyze-toc-btn" style="width: 100%; font-size: 0.9em;">ToC
                                    analysieren</button>
                                <div id="toc-status"
                                    style="font-size: 0.8em; margin-top: 5px; color: var(--text-color); opacity: 0.8;">
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- Export Optionen -->
                    <details id="export-options-details">
                        <summary>Export Formattierung</summary>
                        <div class="details-content">
                            <div class="control-group horizontal">
                                <label for="docx-opt-unit-cm" title="\text{...} entfernen">Einheiten bereinigen</label>
                                <label class="switch"><input type="checkbox" id="docx-opt-unit-cm" checked><span
                                        class="slider"></span></label>
                            </div>
                            <div class="control-group horizontal">
                                <label for="docx-opt-unit-circ" title="^circ zu ¬∞">^circ zu ¬∞</label>
                                <label class="switch"><input type="checkbox" id="docx-opt-unit-circ" checked><span
                                        class="slider"></span></label>
                            </div>
                            <div class="control-group horizontal">
                                <label for="docx-opt-latex-space-block" title="Leerzeichen in $$...$$ entfernen">$$
                                    Spaces</label>
                                <label class="switch"><input type="checkbox" id="docx-opt-latex-space-block"
                                        checked><span class="slider"></span></label>
                            </div>
                            <div class="control-group horizontal">
                                <label for="docx-opt-latex-space-inline" title="Leerzeichen in $...$ entfernen">$
                                    Spaces</label>
                                <label class="switch"><input type="checkbox" id="docx-opt-latex-space-inline"
                                        checked><span class="slider"></span></label>
                            </div>
                            <div class="control-group horizontal">
                                <label for="docx-opt-greek" title="Œ± zu \alpha etc.">Griechisch zu LaTeX</label>
                                <label class="switch"><input type="checkbox" id="docx-opt-greek" checked><span
                                        class="slider"></span></label>
                            </div>
                            <div class="control-group horizontal">
                                <label for="docx-opt-supsub" title="¬≤ zu ^2, ‚ÇÉ zu _3">Hoch/Tiefzahlen conv.</label>
                                <label class="switch"><input type="checkbox" id="docx-opt-supsub" checked><span
                                        class="slider"></span></label>
                            </div>
                            <div class="control-group horizontal">
                                <label for="docx-opt-nonascii" title="‚â§ zu \leq etc.">Sonderzeichen zu LaTeX</label>
                                <label class="switch"><input type="checkbox" id="docx-opt-nonascii" checked><span
                                        class="slider"></span></label>
                            </div>
                            <div class="control-group horizontal">
                                <label for="docx-opt-nbsp-narrow">NBSP schmal (\u202F)</label>
                                <label class="switch"><input type="checkbox" id="docx-opt-nbsp-narrow" checked><span
                                        class="slider"></span></label>
                            </div>
                            <div class="control-group horizontal">
                                <label for="docx-opt-latex">LaTeX rendern (&lt;L&gt;)</label>
                                <label class="switch"><input type="checkbox" id="docx-opt-latex" checked><span
                                        class="slider"></span></label>
                            </div>
                            <div class="control-group horizontal">
                                <label for="docx-opt-dollar">$ entfernen</label>
                                <label class="switch"><input type="checkbox" id="docx-opt-dollar" checked><span
                                        class="slider"></span></label>
                            </div>
                            <div class="control-group horizontal">
                                <label for="docx-opt-cdot">\cdot zu *</label>
                                <label class="switch"><input type="checkbox" id="docx-opt-cdot" checked><span
                                        class="slider"></span></label>
                            </div>
                            <div class="control-group horizontal">
                                <label for="docx-opt-images">Bilder-Tags conv.</label>
                                <label class="switch"><input type="checkbox" id="docx-opt-images" checked><span
                                        class="slider"></span></label>
                            </div>
                            <div class="control-group horizontal">
                                <label for="docx-opt-dashes">Trennlinien entfernen</label>
                                <label class="switch"><input type="checkbox" id="docx-opt-dashes" checked><span
                                        class="slider"></span></label>
                            </div>
                            <div class="control-group horizontal">
                                <label for="docx-opt-tables">Tabellen-Marker</label>
                                <label class="switch"><input type="checkbox" id="docx-opt-tables" checked><span
                                        class="slider"></span></label>
                            </div>
                            <div class="control-group horizontal">
                                <label for="docx-opt-quotes">Typogr. Anf√ºhrungsz.</label>
                                <label class="switch"><input type="checkbox" id="docx-opt-quotes" checked><span
                                        class="slider"></span></label>
                            </div>
                            <div class="control-group horizontal">
                                <label for="docx-opt-hyphens">Gedankenstriche</label>
                                <label class="switch"><input type="checkbox" id="docx-opt-hyphens" checked><span
                                        class="slider"></span></label>
                            </div>
                            <div class="control-group horizontal">
                                <label for="docx-opt-whitespace">Unsichtbare Zeichen</label>
                                <label class="switch"><input type="checkbox" id="docx-opt-whitespace" checked><span
                                        class="slider"></span></label>
                            </div>
                        </div>
                    </details>

                    <!-- API-Einstellungen -->
                    <details id="api-settings-details">
                        <summary>API-Einstellungen</summary>
                        <div class="details-content">
                            <div class="control-group">
                                <label for="pipeline-select">Pipeline:</label>
                                <select id="pipeline-select">
                                    <option value="openai-openwebui" selected>OpenWebUI (OpenAI-Format)</option>
                                    <option value="ollama-openwebui">OpenWebUI (Ollama-Format)</option>
                                    <option value="ollama">Lokal (Ollama)</option>
                                    <option value="openai">Lokal (LM Studio/OpenAI)</option>
                                </select>
                            </div>

                            <div class="control-group">
                                <label for="base-url">Basis-URL:</label>
                                <input type="text" id="base-url"
                                    value="https://openwebui.sbbz-ilvesheim.de/api/chat/completions">
                            </div>

                            <div class="control-group">
                                <label for="api-key">API Key:</label>
                                <input type="password" id="api-key" placeholder="sk-..." autocomplete="section-api-key">
                            </div>

                            <div class="control-group model-selection-group">
                                <button id="fetch-models-btn">Modelle abrufen</button>
                                <div>
                                    <label for="model-name" class="sr-only">Modell:</label>
                                    <select id="model-name">
                                        <option value="" disabled selected>Zuerst laden...</option>
                                    </select>
                                    <input type="text" id="custom-model-name" placeholder="Modell manuell eingeben"
                                        style="display:none; margin-top:5px;">
                                </div>
                            </div>

                            <div class="control-group">
                                <label for="prompt">System Prompt (Flipping):</label>
                                <textarea id="prompt" rows="12">* Extract all text in a logical order, as if you were reading it naturally.
* NEVER add additional sentences.
* Rebuild the headings.
* Format the text with markdown syntax.
* Don't translate text.
* Don't give answers to questions from the text.
* Don't solve math problems.
* Return what is on the page, NEVER add additional sentences, that describe your actions.
* Don't add ```markdown or ```
* Describe illustrations at their logical positions comprehensively in German. Use the following internal structure:

((Bild))<br/>
Art der Abbildung (z. B. Foto, Zeichnung, Diagramm):<br/>
Beschreibung: ‚Ä¶  / Bildtext: ‚Ä¶<br/>
((/Bild))

* Place captions and titles above the ((Bild))((/Bild)) tag if they exist in the source.
* Use LaTeX for ALL mathematical expressions.
* Put $$ around LaTeX sections.
* Put $ around LaTeX expressions embedded in text.
* Don't put [ or ] around LaTeX.
* Do the ocr twice and check if nothing is missing from the original page.
* Double check mathematical expressions for correctness.
* Double check if the markdown syntax is correct.</textarea>
                            </div>

                            <div class="control-group">
                                <label for="vision-prompt">Vision Prompt (Anschauen & Fragen):</label>
                                <textarea id="vision-prompt" rows="6">* Describe what can be seen in the image accurately and helpfully.
* Be concise, but don't leave out any important details.
* Respond directly to the user (you).
* Speak German.
* Don't format the text.</textarea>
                            </div>

                            <!-- Weitere Parameter -->
                            <details style="border:none; background:transparent;">
                                <summary style="font-size:0.9em; padding:0;">Erweiterte Parameter</summary>
                                <div class="details-content"
                                    style="border:none; padding-left:0; padding-right:0; gap:5px;">
                                    <div class="control-group horizontal">
                                        <label for="temperature">Temperatur (0-2):</label>
                                        <input type="number" id="temperature" value="0.1" step="0.1"
                                            style="width: 60px; text-align: center;">
                                    </div>
                                    <div class="control-group horizontal">
                                        <label for="repeat-penalty">Repeat Penalty:</label>
                                        <input type="number" id="repeat-penalty" value="1.5" step="0.1"
                                            style="width: 60px;">
                                    </div>
                                    <div class="control-group horizontal">
                                        <label for="top-p">Top P:</label>
                                        <input type="number" id="top-p" value="0.9" step="0.1" style="width: 60px;">
                                    </div>
                                    <div class="control-group horizontal">
                                        <label for="top-k">Top K:</label>
                                        <input type="number" id="top-k" value="40" step="1" style="width: 60px;">
                                    </div>
                                    <div class="control-group horizontal">
                                        <label for="delay">Verz√∂gerung (ms):</label>
                                        <input type="number" id="delay" value="100" step="100" style="width: 70px;">
                                    </div>
                                    <div class="control-group horizontal">
                                        <label for="retries">Wiederholungen:</label>
                                        <input type="number" id="retries" value="1" min="0" max="5"
                                            style="width: 60px;">
                                    </div>
                                </div>
                            </details>
                        </div>
                    </details>
                </div>
            </details>

            <div class="ai-disclaimer">
                <span aria-hidden="true">‚ö†Ô∏è</span> KI kann Fehler machen. √úberpr√ºfen Sie wichtige Infos.
            </div>
        </div>

        <!-- Rechte Spalte: Main Content -->
        <div class="main-content">
            <!-- Vorschau Bereich -->
            <div class="preview-area" id="preview-area">
                <!-- Eingabe-Vorschau -->
                <div class="preview-panel" id="input-preview-panel">
                    <div class="preview-panel-header">
                        <h3>Eingabe</h3>
                        <div class="img-nav-controls" id="img-nav-controls" style="display:none;">
                            <button id="img-prev-btn" title="Vorheriges Bild" aria-label="Vorheriges Bild">‚óÄ</button>
                            <input type="number" id="img-nav-input" value="1" min="1" aria-label="Gehe zu Bild Seite">
                            <span id="img-total-count" style="font-size:0.9em; margin-left:5px;">/ ?</span>
                            <button id="img-next-btn" title="N√§chstes Bild" aria-label="N√§chstes Bild">‚ñ∂</button>
                        </div>
                    </div>
                    <img id="image-preview" alt="Vorschau" style="display:none;">
                </div>

                <!-- Ausgabe-Vorschau -->
                <div class="preview-panel" id="output-preview-panel">
                    <div class="preview-panel-header">
                        <h3>Ergebnis</h3>
                        <div class="preview-controls">
                            <button id="toggle-raw-btn" class="active" aria-pressed="true"
                                title="Zeige Rohdaten (JSON/Text)">Rohdaten</button>
                            <button id="toggle-rendered-btn" aria-pressed="false"
                                title="Zeige gerenderte Vorschau (HTML)">Vorschau</button>
                            <button id="tts-btn" title="Vorlesen" aria-label="Text vorlesen lassen">üîä Vorlesen</button>
                        </div>
                    </div>
                    <textarea id="raw-preview" readonly spellcheck="false"
                        placeholder="Erkannter Text erscheint hier..."></textarea>
                    <div id="rendered-preview" style="display: none;"></div>
                </div>
            </div>

            <!-- Log Bereich -->
            <div class="log-area" id="log-area" role="log" aria-live="polite"></div>
        </div>
    </div>

    <!-- MODAL: Passwort -->
    <div id="password-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h3>Sicherheit</h3>
            <p id="modal-message">Bitte Passwort eingeben:</p>
            <input type="password" id="modal-input" class="search-input">
            <div class="modal-buttons">
                <button id="modal-cancel" class="btn-cancel">Abbrechen</button>
                <button id="modal-ok">OK</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Shortcuts -->
    <div id="keyboard-shortcuts-modal" class="modal-overlay" style="display:none;"
        onclick="if(event.target === this) this.style.display='none'">
        <div class="modal-content">
            <h3>Tastenk√ºrzel</h3>
            <div class="shortcut-list">
                <div class="shortcut-key">s</div>
                <div>Start/Stop Verarbeitung</div>
                <div class="shortcut-key">c</div>
                <div>Kamera / Vision √∂ffnen</div>
                <div class="shortcut-key">i</div>
                <div>Dateien ausw√§hlen</div>
                <div class="shortcut-key">m / d</div>
                <div>Download MD / DOCX</div>
                <div class="shortcut-key">r / p</div>
                <div>Rohdaten / Vorschau umschalten</div>
                <div class="shortcut-key">t</div>
                <div>Vorlesen (TTS)</div>
                <div class="shortcut-key">o</div>
                <div>Einstellungen √∂ffnen/schlie√üen</div>
                <div class="shortcut-key">1 / 2 / 3</div>
                <div>Settings-Sektionen schalten</div>
                <div class="shortcut-key">a</div>
                <div>ToC analysieren</div>
                <div class="shortcut-key">f</div>
                <div>Kamera Fertig / Schlie√üen</div>
                <div class="shortcut-key">v</div>
                <div>Vision Mode (Chat) umschalten</div>
                <div class="shortcut-key">Esc</div>
                <div>Modals / Kamera schlie√üen</div>
                <div class="shortcut-key">‚Üê / ‚Üí</div>
                <div>Bild-Navigation</div>
            </div>
            <div class="modal-buttons">
                <button
                    onclick="document.getElementById('keyboard-shortcuts-modal').style.display='none'">Schlie√üen</button>
            </div>
        </div>
    </div>

    <!-- MODAL: CAMERA -->
    <div id="camera-modal" class="modal-overlay" style="display:none; align-items: flex-start; padding-top: 20px;">
        <div class="modal-content large" style="height: 90vh; display: flex; flex-direction: column;">
            <div class="header-row" style="margin-bottom: 5px; flex-shrink: 0;">
                <h3>Kamera / Vision</h3>
                <button id="camera-close" class="header-btn"
                    style="background:transparent; border:none; font-size:1.5em;" aria-label="Schlie√üen">‚úñ</button>
            </div>

            <div
                style="flex: 1; position: relative; background: #000; overflow: hidden; display: flex; justify-content: center; align-items: center;">
                <video id="camera-stream" autoplay playsinline muted></video>
                <div id="camera-batch-counter">Stapel: 0</div>
                <div id="camera-status"
                    style="position:absolute; bottom:10px; left:10px; color:white; background:rgba(0,0,0,0.5); padding:2px 5px;">
                </div>
            </div>

            <div id="vision-ui-container"
                style="display: none; flex-direction: column; gap: 5px; border: 1px solid var(--border-color); padding: 5px; border-radius: 4px; background: rgba(0,0,0,0.2);">
                <div id="vision-response-area"
                    style="height: 100px; overflow-y: auto; background: var(--input-bg); padding: 5px; font-size: 0.9em; white-space: pre-wrap; color: var(--text-color);">
                </div>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="vision-user-input" placeholder="Frage zum Bild..." style="flex: 1;"
                        aria-label="Frage zum Bild">
                    <button id="vision-send-btn" title="Frage an Vision-Modell senden">Senden</button>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 0.8em; opacity: 0.7;">Fragt das zuletzt aufgenommene Bild.</div>
                    <div class="control-group horizontal" style="gap: 5px;">
                        <label for="vision-mute-toggle" style="font-size: 0.8em;">Stumm</label>
                        <label class="switch" style="width: 28px; height: 16px;">
                            <input type="checkbox" id="vision-mute-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div
                style="display: flex; justify-content: space-between; align-items: center; gap: 10px; padding: 10px 0;">
                <div class="control-group horizontal"
                    style="justify-content: center; background: var(--secondary-color); padding: 5px; border-radius: 4px; flex: 1;">
                    <label for="vision-mode-toggle" style="font-weight:bold; color: var(--primary-color);">Vision
                        Mode</label>
                    <label class="switch">
                        <input type="checkbox" id="vision-mode-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <button id="camera-snap"
                    style="flex: 2; font-size: 1.2em; padding: 15px; background-color: var(--primary-color);"
                    title="Foto aufnehmen (Leertaste/Enter)">Foto
                    machen</button>

                <button id="camera-finish-btn"
                    style="flex: 1; font-size: 1em; padding: 15px; background-color: var(--secondary-color); color: var(--text-color); border: 1px solid var(--border-color);"
                    onclick="stopCameraModal()" title="Kamera schlie√üen" aria-label="Kamera schlie√üen">Fertig</button>
            </div>

            <details>
                <summary style="font-size: 0.9em; padding: 2px;">Erweiterte Kamera-Optionen</summary>
                <div class="details-content">
                    <div class="control-group">
                        <label for="camera-select">Kamera w√§hlen:</label>
                        <select id="camera-select" style="font-size: 0.9em; padding: 4px;"></select>
                    </div>
                    <div class="control-group horizontal">
                        <label for="camera-res-full">Maximale Aufl√∂sung (Max Res)</label>
                        <input type="checkbox" id="camera-res-full" checked>
                    </div>
                    <div class="control-group horizontal" id="camera-pixel-group" style="display:none;">
                        <label for="camera-max-pixels">Max Pixel (lange Seite):</label>
                        <input type="number" id="camera-max-pixels" value="1280" step="100" style="width: 80px;">
                    </div>
                    <div class="control-group horizontal">
                        <label for="camera-auto-process">Auto-Verarbeitung nach Schlie√üen</label>
                        <input type="checkbox" id="camera-auto-process">
                    </div>
                    <div class="control-group horizontal">
                        <label for="camera-auto-vision-mode">Auto-Vision-Mode starten</label>
                        <input type="checkbox" id="camera-auto-vision-mode">
                    </div>
                    <div class="control-group horizontal">
                        <label for="camera-auto-save">Auto-Download (DOCX)</label>
                        <input type="checkbox" id="camera-auto-save">
                    </div>
                    <div class="control-group horizontal">
                        <label for="camera-auto-read">Auto-Vorlesen</label>
                        <input type="checkbox" id="camera-auto-read">
                    </div>
                </div>
            </details>
        </div>
    </div>

    <script>
        document.getElementById('keyboard-shortcuts-btn').addEventListener('click', () => {
            document.getElementById('keyboard-shortcuts-modal').style.display = 'flex';
        });

        document.addEventListener('keydown', (e) => {
            // Abbrechen mit Esc
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none');
                if (typeof stopCameraModal === 'function') stopCameraModal();
            }

            // Shortcuts nur wenn kein Input-Feld fokussiert ist
            if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
                // Ausnahme: Alt+Key oder Enter in bestimmten Feldern
                if (e.key === 'Enter' && e.ctrlKey && document.activeElement.id === 'manual-prompt') {
                    const startBtn = document.getElementById('toggle-processing-btn');
                    if (startBtn && !startBtn.disabled) startBtn.click();
                }
                return;
            }

            const key = e.key.toLowerCase();

            // s = Start / Stop
            if (key === 's') {
                e.preventDefault();
                const btn = document.getElementById('toggle-processing-btn');
                if (btn && !btn.disabled) btn.click();
            }

            // c = Camera
            if (key === 'c') {
                e.preventDefault();
                const btn = document.getElementById('camera-btn');
                if (btn) btn.click();
            }

            // f = Finish Camera (if modal open)
            if (key === 'f') {
                const modal = document.getElementById('camera-modal');
                if (modal && modal.style.display !== 'none') {
                    e.preventDefault();
                    if (typeof stopCameraModal === 'function') stopCameraModal();
                }
            }

            // v = Vision Mode toggle (if camera modal open)
            if (key === 'v') {
                const modal = document.getElementById('camera-modal');
                if (modal && modal.style.display !== 'none') {
                    e.preventDefault();
                    const toggle = document.getElementById('vision-mode-toggle');
                    if (toggle) {
                        toggle.checked = !toggle.checked;
                        toggle.dispatchEvent(new Event('change'));
                    }
                }
            }

            // i = Input (Files)
            if (key === 'i') {
                e.preventDefault();
                document.getElementById('file-input').click();
            }

            // m = MD Download
            if (key === 'm') {
                e.preventDefault();
                const btn = document.getElementById('download-md-btn');
                if (btn && !btn.disabled) btn.click();
            }

            // d = DOCX Download
            if (key === 'd') {
                e.preventDefault();
                const btn = document.getElementById('download-docx-btn');
                if (btn && !btn.disabled) btn.click();
            }

            // o = Options (Main)
            if (key === 'o') {
                e.preventDefault();
                const det = document.getElementById('main-settings');
                if (det) det.open = !det.open;
            }

            // 1, 2, 3 = Settings Sub-Sections
            if (key === '1') {
                const det = document.getElementById('api-settings-details');
                if (det) det.open = !det.open;
            }
            if (key === '2') {
                const det = document.getElementById('processing-options-details');
                if (det) det.open = !det.open;
            }
            if (key === '3') {
                const det = document.getElementById('export-options-details');
                if (det) det.open = !det.open;
            }

            // a = Analyze ToC
            if (key === 'a') {
                const btn = document.getElementById('analyze-toc-btn');
                if (btn && !btn.disabled) btn.click();
            }

            // r = Raw
            if (key === 'r') {
                e.preventDefault();
                const btn = document.getElementById('toggle-raw-btn');
                if (btn) btn.click();
            }

            // p = Preview (Rendered)
            if (key === 'p') {
                e.preventDefault();
                const btn = document.getElementById('toggle-rendered-btn');
                if (btn) btn.click();
            }

            // t = TTS
            if (key === 't') {
                e.preventDefault();
                const btn = document.getElementById('tts-btn');
                if (btn) btn.click();
            }

            // Pfeiltasten f√ºr Bild-Navigation
            if (key === 'arrowleft') {
                const btn = document.getElementById('img-prev-btn');
                if (btn && btn.parentElement.style.display !== 'none') btn.click();
            }
            if (key === 'arrowright') {
                const btn = document.getElementById('img-next-btn');
                if (btn && btn.parentElement.style.display !== 'none') btn.click();
            }
        });
    </script>

    <!-- Scripts -->
    <script src="js/globals.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/camera.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/file-handling.js"></script>
    <script src="js/processing.js"></script>
    <script src="js/main.js"></script>

</body>

</html>